
### ğŸ“ **æ–‡ä»¶: `src/types/schema.ts**`

**ä¿®æ­£ç‚¹ï¼š** åœ¨ `EventOptionSchema.effects` ä¸­å¢åŠ  `items` å­—æ®µæ”¯æŒç‰©å“è·å–/æ¶ˆè€—ã€‚

```typescript
import { z } from 'zod';

export enum PlayerClass {
  Homeless = 'HOMELESS',
  Worker = 'WORKER',
  Middle = 'MIDDLE',
  Capitalist = 'CAPITALIST'
}

// --- Zod Schemas ---

export const ItemSchema = z.object({
  id: z.string(),
  name: z.string(),
  price: z.number(),
  effects: z.object({
    hp: z.number(),
    san: z.number(),
    maxHp: z.number().optional(),
  }),
  tags: z.array(z.enum(['CONSUMER', 'AWAKENING', 'DARK_WEB', 'WEAPON', 'TICKET'])),
  requiredClass: z.nativeEnum(PlayerClass).optional(),
  unlockCondition: z.string().optional(),
  flavorText: z.string(),
});

export const BillSchema = z.object({
  id: z.string(),
  name: z.string(),
  amount: z.number(),
  type: z.enum(['SURPRISE', 'JUMP_SCARE']),
  triggerCondition: z.object({
    minGold: z.number().optional(),
    maxGold: z.number().optional(),
    requiredClass: z.array(z.nativeEnum(PlayerClass)).optional(),
    isDebtOnly: z.boolean().optional(),
  }),
  flavorText: z.string(),
});

/**
 * äº‹ä»¶é€‰é¡¹ Schema (ä¿®æ­£ç‰ˆ)
 * æ–°å¢: items å­—æ®µï¼Œæ”¯æŒè·å¾—(æ­£æ•°)æˆ–å¤±å»(è´Ÿæ•°)ç‰©å“
 */
export const EventOptionSchema = z.object({
  label: z.string(),
  effects: z.object({
    hp: z.number().optional(),
    gold: z.number().optional(),
    san: z.number().optional(),
    points: z.object({
      red: z.number().optional(),
      wolf: z.number().optional(),
      old: z.number().optional(),
    }).optional(),
    // [Fix #2] ç‰©å“å˜æ›´æ”¯æŒ
    items: z.array(z.object({
      itemId: z.string(),
      count: z.number(), // +1 è·å¾—, -1 æ¶ˆè€—
    })).optional(),
  }),
  archiveId: z.string().optional(), 
});

export const EventSchema = z.object({
  id: z.string(),
  title: z.string(),
  text: z.object({
    lowSan: z.string(),
    highSan: z.string(),
  }),
  conditions: z.object({
    minSan: z.number().optional(),
    maxSan: z.number().optional(),
    requiredClass: z.array(z.nativeEnum(PlayerClass)).optional(),
  }),
  options: z.object({
    A: EventOptionSchema,
    B: EventOptionSchema,
    C: EventOptionSchema,
    D: EventOptionSchema.extend({
      sanLock: z.number().default(70),
      isGlitched: z.boolean().default(false),
    }),
  }),
});

export const EndingSchema = z.object({
  id: z.string(),
  title: z.string(),
  description: z.string(),
  priority: z.number(),
  type: z.enum(['DEATH', 'SURVIVAL', 'ALIENATION', 'STANCE', 'UR']),
});

export type Item = z.infer<typeof ItemSchema>;
export type Bill = z.infer<typeof BillSchema>;
export type GameEvent = z.infer<typeof EventSchema>;
export type Ending = z.infer<typeof EndingSchema>;

```

---

### ğŸ“ **æ–‡ä»¶: `src/logic/core.ts**`

**ä¿®æ­£ç‚¹ï¼š** `triggerBill` å¢åŠ å…œåº•é€»è¾‘ï¼Œé˜²æ­¢â€œå‘½ä¸­æ¦‚ç‡å´æ— äº‹å‘ç”Ÿâ€çš„æƒ…å†µã€‚

```typescript
import { PlayerClass, Bill } from '../types/schema';

// ... calcSalary ä¿æŒä¸å˜ ...
export const calcSalary = (baseSalary: number, currentSan: number): number => {
  let efficiency = 1.0;
  if (currentSan >= 0 && currentSan <= 20) efficiency = 1.0;
  else if (currentSan > 20 && currentSan <= 60) efficiency = 0.7;
  else efficiency = 0.4;
  return Math.floor(baseSalary * efficiency);
};

/**
 * é€»è¾‘ 2: è´¦å•è§¦å‘ç³»ç»Ÿ (ä¿®æ­£ç‰ˆ)
 * [Fix #1] å¢åŠ å…œåº•è´¦å• (Fallback Bills)ï¼Œç»´æŒç”Ÿå­˜å‹è¿«æ„Ÿ
 */
export const triggerBill = (
  gold: number,
  currentClass: PlayerClass,
  billPool: Bill[]
): Bill | null => {
  // 1. ç¡®å®šè§¦å‘æ¦‚ç‡
  const isInDebt = gold < 0;
  const baseProb = 0.08;
  const actualProb = isInDebt ? 0.16 : baseProb;

  // 2. æ·éª°å­
  if (Math.random() > actualProb) return null;

  // 3. åŸºäºæ¡ä»¶è¿‡æ»¤è´¦å•æ± 
  const validBills = billPool.filter(bill => {
    if (bill.triggerCondition.isDebtOnly && !isInDebt) return false;
    if (bill.triggerCondition.requiredClass && !bill.triggerCondition.requiredClass.includes(currentClass)) return false;
    if (bill.triggerCondition.minGold !== undefined && gold < bill.triggerCondition.minGold) return false;
    return true;
  });

  // [Fix #1] å…œåº•é€»è¾‘ï¼šå¦‚æœå‘½ä¸­æ¦‚ç‡ä½†æ²¡æœ‰åŒ¹é…çš„ç‰¹å®šè´¦å•ï¼Œå¼ºåˆ¶æ´¾å‘é€šç”¨å°é¢è´¦å•
  if (validBills.length === 0) {
    return {
      id: 'BILL_FALLBACK_01',
      name: 'ä¸æ˜å¼€æ”¯',
      amount: -10, // å°é¢æ‰£æ¬¾
      type: 'JUMP_SCARE',
      triggerCondition: {},
      flavorText: 'ä½ çš„å£è¢‹æ¼äº†ä¸€ä¸ªæ´ï¼Œæˆ–è€…ä½ åªæ˜¯è®°é”™äº†ã€‚åæ­£å°‘äº† 10 å—é’±ã€‚'
    };
  }

  // 4. æŠ½å–
  const randomIndex = Math.floor(Math.random() * validBills.length);
  return validBills[randomIndex];
};

// ... checkClassUpdate, humanDismantlementCheck ä¿æŒä¸å˜ ...
export const checkClassUpdate = (gold: number): PlayerClass => {
  if (gold < 500) return PlayerClass.Homeless;
  if (gold >= 500 && gold < 5000) return PlayerClass.Worker;
  if (gold >= 5000 && gold < 50000) return PlayerClass.Middle;
  return PlayerClass.Capitalist;
};

interface DismantleResult {
  triggered: boolean;
  type: 'PASSIVE' | 'ACTIVE';
  changes: { goldSetTo: number; maxHpMultiplier: number; debtReset: boolean; };
}

export const humanDismantlementCheck = (
  currentClass: PlayerClass,
  debtDayCounter: number,
  gold: number,
  isShopAction: boolean = false
): DismantleResult | null => {
  const passiveTrigger = currentClass === PlayerClass.Homeless && debtDayCounter >= 3;
  const activeTrigger = isShopAction && gold < -2000;

  if (passiveTrigger || activeTrigger) {
    return {
      triggered: true,
      type: activeTrigger ? 'ACTIVE' : 'PASSIVE',
      changes: { goldSetTo: 0, maxHpMultiplier: 0.5, debtReset: true }
    };
  }
  return null;
};

```

---

### ğŸ“ **æ–‡ä»¶: `src/logic/endings.ts**`

**ä¿®æ­£ç‚¹ï¼š** ç»†åŒ– Worker é˜¶çº§åœ¨ç»“å±€æ—¶çš„åˆ¤å®šé€»è¾‘ï¼Œé¿å…æœ‰é’±çš„å·¥äººè¢«è¯¯åˆ¤ä¸ºâ€œæœˆå…‰ç”µæ± â€ã€‚

```typescript
import { GameState } from '../store/types';
import { PlayerClass } from '../types/schema';

export const resolveEnding = (state: GameState, deathReason?: 'HP' | 'SUICIDE' | 'DISMANTLED' | 'COP'): string => {
  const { hp, san, gold, currentClass, points, hasRedBook, hasCryptoKey } = state;

  // --- ä¼˜å…ˆçº§ 1: æ­»äº¡ ---
  if (hp <= 0 || deathReason) {
    if (deathReason === 'DISMANTLED') return 'ED-03';
    if (deathReason === 'COP') return 'ED-04';
    if (deathReason === 'SUICIDE' || (san > 80 && deathReason === 'HP')) return 'ED-05';
    if (currentClass === PlayerClass.Homeless) return 'ED-01';
    return 'ED-02';
  }

  if (state.day < 40) return '';

  // --- ä¼˜å…ˆçº§ 2: UR ---
  const hasTrueInsight = 
    state.unlockedArchives.includes('No.16') && 
    state.unlockedArchives.includes('No.05') && 
    hasRedBook && 
    san >= 95;

  if (hasTrueInsight) return 'ED-20';

  // --- ä¼˜å…ˆçº§ 3: å¼‚åŒ– ---
  const isMad = san < 10 || san > 90;
  if (isMad) {
    if (gold < 1000) return 'ED-10';
    return 'ED-11';
  }

  // --- ä¼˜å…ˆçº§ 4: ç«‹åœº ---
  const { red, wolf, old } = points;
  if (old > 0 && old >= red && old >= wolf) return 'ED-15';
  if (red > 0 && (red > wolf || hasRedBook)) return 'ED-13';
  if (wolf > 0 && (wolf > red || hasCryptoKey)) return 'ED-14';

  // --- ä¼˜å…ˆçº§ 5: åº¸äºº (ç”Ÿå­˜) ---
  switch (currentClass) {
    case PlayerClass.Capitalist: return 'ED-09'; // çŒªçš„å¿«ä¹
    case PlayerClass.Middle: return 'ED-08'; // ä¸­äº§å™©æ¢¦
    case PlayerClass.Worker: 
      // [Fix #3] ç»†åˆ†é€»è¾‘ï¼š
      // Gold < 1000 -> ED-06 æœˆå…‰ç”µæ±  (æ ‡å‡†ç»“å±€)
      // Gold >= 1000 -> ED-07 æ²‰é»˜çš„è€—æ (è™½ç„¶æœ‰é’±ä½†ä¾ç„¶æ˜¯åº•å±‚ï¼Œç²¾ç¥ä¸Šå·²å¦‚æµæµªæ±‰èˆ¬éº»æœ¨)
      return (gold < 1000) ? 'ED-06' : 'ED-07'; 
    case PlayerClass.Homeless: return 'ED-07'; // æ²‰é»˜çš„è€—æ
    default: return 'ED-06';
  }
};

```

---

### ğŸ“ **æ–‡ä»¶: `src/hooks/useVisualFilter.ts**`

**ä¿®æ­£ç‚¹ï¼š** æ·»åŠ äº† `tailwind.config.js` çš„é…ç½®æç¤ºï¼Œç¡®ä¿å­—ä½“ç±»åæœ‰æ•ˆã€‚

```typescript
import { useMemo } from 'react';
import { useGameStore } from '../store/useGameStore';

/**
 * è§†è§‰æ»¤é•œ Hook
 * * [Fix #4 - é…ç½®æç¤º]
 * è¯·ç¡®ä¿åœ¨ tailwind.config.js ä¸­é…ç½®äº†ä»¥ä¸‹ FontFamily:
 * theme: {
 * extend: {
 * fontFamily: {
 * 'creepster': ['"Creepster"', 'system-ui', 'cursive'], // éœ€è¦å¼•å…¥ Google Fonts æˆ–æœ¬åœ°å­—ä½“
 * 'mono': ['"Courier New"', 'monospace'],
 * }
 * }
 * }
 */
export const useVisualFilter = () => {
  const san = useGameStore((state) => state.san);

  const filterStyle = useMemo(() => {
    // é˜¶æ®µ 1: è“è¯ä¸¸ (0-30)
    if (san <= 30) {
      return {
        className: 'theme-blue-pill',
        style: {
          filter: 'sepia(0.3) contrast(0.9) saturate(1.2)',
          transition: 'filter 1s ease',
        },
        fontClass: 'font-sans'
      };
    }
    
    // é˜¶æ®µ 2: è£‚ç—• (31-70)
    if (san <= 70) {
      return {
        className: 'theme-cracks',
        style: {
          filter: 'contrast(1.2) hue-rotate(-5deg)',
          transition: 'filter 1s ease',
        },
        fontClass: 'font-mono'
      };
    }

    // é˜¶æ®µ 3: å¤ç¥ (71-100)
    return {
      className: 'theme-old-ruler',
      style: {
        filter: 'invert(0.9) grayscale(0.6) contrast(1.5)',
        textShadow: '0 0 5px rgba(255, 0, 0, 0.7)',
        transition: 'filter 0.5s ease',
      },
      // å¿…é¡»åœ¨ Tailwind é…ç½®æ–‡ä»¶ä¸­æ³¨å†Œæ­¤å­—ä½“
      fontClass: 'font-creepster' 
    };
  }, [san]);

  return filterStyle;
};

```